package com.mql.dao;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.mql.domain.User;


public class Query extends BaseDao {
	public Map<String,Object> queryUser(String sort,String order,int page,int pageSize) {
		// TODO Auto-generated method stub
		Map<String,Object> map=new HashMap<String,Object>();
		List<User> list=new ArrayList<User>();
		try {
			String sql = "select name as user,number as email from msg_manuscripts order by "+sort+" "+order+" limit ?,?";
			getConnection();
			int first=pageSize*(page-1);
			int total=getTotal();
			map.put("total",total);
			pst = conn.prepareStatement(sql);
			pst.setInt(1,first);
			pst.setInt(2,pageSize);
			rs = pst.executeQuery();
			while (rs.next()) {
				User user=new User();
				user.setUser(rs.getString(1));
				user.setEmail(rs.getString(2));
				list.add(user);
			}
			map.put("rows",list);
		} catch (Exception e) {
			e.printStackTrace();
			// TODO: handle exception
		} finally {
			close();
		}
		return map;
	}
	
	public String queryManuscripts(int page,int pageSize) {
		// TODO Auto-generated method stub
		StringBuffer sb=new StringBuffer();
		
		try {
			String sql = "select name as user,number as email  from msg_manuscripts limit ?,?";

			getConnection();
			int first=pageSize*(page-1);
			int total=getTotal();
			pst = conn.prepareStatement(sql);
			pst.setInt(1,first);
			pst.setInt(2,pageSize);
			rs = pst.executeQuery();
			sb.append("[{\"total\" : "+total+"},{\"rows\" : [");
			boolean b=false;
			while (rs.next()) {
				if(!b){
					b=true;
				}
				sb.append("{\"user\" : \""+rs.getString(1)+"\",\"email\" : \""+rs.getString(2)+"\"},");
			}
			if(b)
			sb=sb.deleteCharAt(sb.length()-1);
			sb.append("]}]");
		} catch (Exception e) {
			e.printStackTrace();
			// TODO: handle exception
		} finally {
			close();
		}
		return sb.toString();
	}
	
	public int getTotal(){
		int total=0;
		String sql = "select count(*) from msg_manuscripts";
		try {
			pst = conn.prepareStatement(sql);
			rs = pst.executeQuery();
			rs.next();
			total = rs.getInt(1);
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return total;
	}
}
